#@type:grammar;@schema:spec;
GRAMMAR_PARSE{
TOKENS:
	NAME:= [A-Z][A-Z0-9_]{0,19}
	COND:= [^\n]+
	STATEVAL:= [^;\n,]+
	VERB:= EMIT_CHAT|EMIT_LOG|EMIT_CTX|HALT|CONTINUE|RETRY|REQUIRE|ASSERT|WARN|ERROR|DENY|SET|CLEAR|PUSH_STATE|POP_STATE|CALL_TOOL|DELEGATE|SAVE_BIO|SAVE_PROJECT|SET_DOMAIN
	MSG:= "\""[\\x20-\\x7E]*"\""
	ARROW:= "->"
	SEMI:= ";"
	LBRACE:= "{"
	RBRACE:= "}"
	COLON:= ":"
	COMMA:= ","
	NL:= "\n"
	LEXER: IGNORE(" "|"\\t"|"\r")REQUIRE(NL)FORBID(COMMENTS)
STRUCTURE:
	FILE:= (BLOCK NL*)+
	BLOCK:= NAME LBRACE NL PRECONDITION_LINE ACTION_SECTION STATE_LINE RBRACE NL
	PRECONDITION_LINE:= "PRECONDITION"COLON COND NL
	ACTION_SECTION:= "ACTION"COLON NL ACTION_RULE+
	ACTION_RULE:= ( "IF" COND ARROW VERB ACTION_ARG_OPT | VERB ACTION_ARG_OPT ) SEMI NL
	ACTION_ARG_OPT := Îµ | MSG | NAME | NAME MSG
	STATE_LINE:= "STATE"COLON LBRACE STATE_BODY RBRACE NL
	STATE_BODY:= STATE_KV_LIST | STATE_NAME_LIST
	STATE_NAME_LIST:= NAME(COMMA NAME)*
	STATE_KV:= NAME "=" STATEVAL
	STATE_KV_LIST:= STATE_KV(STATE_SEP STATE_KV)*
	STATE_SEP:= ";" | ","
CONSTRAINTS:
	C1: ONE_RULE_PER_LINE
	C2: NL_REQUIRED_AFTER_ALL_RULES
	C3: VERB_NAME_COND_UPPERCASE
	C4: MSG_ASCII_SINGLELINE
	C5: NO_EXTRA_CONTENT
	C6: NO_COMMENTS
	C7: ASCII_ONLY_SOURCE
SEMANTICS:
	S1: TOP_TO_BOTTOM_EVAL
	S2: MULTIPLE_TRUE_EXECUTES_ALL
	S3: NO_IMPLICIT_ELSE
	S4: ON_PARSE_FAIL -> ERROR(BLOCK,LINE)
DETERMINISM:
	D1: IGNORE_WS
	D2: NL_BOUNDARIES_AUDIT
	D3: ONE_RULE_PER_LINE_ISOLATION
}

#@type:grammar;@schema:procedure;
GRAMMAR_PRIMITIVE_SEMANTICS{
PRECONDITION:START
ACTION:
	SET "PRIMITIVE_RULE_1=PRIMITIVE_NAMES_RESERVED";
	SET "PRIMITIVE_RULE_2=NO_PROCEDURE_MAY_DEFINE_A_NAME_ENDING_WITH__PRIMITIVE";
	SET "PRIMITIVE_RULE_3=PROCEDURES_CALL_PRIMITIVES_DIRECTLY";
	SET "PRIMITIVE_RULE_4=WRAPPERS_ALLOWED_ONLY_WITH_DIFFERENT_NAME_AND_EXPLICIT_SCOPE";

	SET "OVERLAP_EXISTS_PRIMITIVE=BOOL OVERLAP_EXISTS_PRIMITIVE(SET A,SET B) -> TRUE iff EXISTS x where x in A AND x in B; else FALSE; if A or B empty/missing -> FALSE";
	SET "ROUND_HALF_UP_PRIMITIVE=NUMBER ROUND_HALF_UP_PRIMITIVE(NUMBER VALUE,INT DP) -> VALUE rounded to DP decimals using half-up rule";
	SET "REPEAT_PRIMITIVE=STRING REPEAT_PRIMITIVE(STRING GLYPH,INT COUNT) -> GLYPH repeated COUNT times; if COUNT<=0 -> ''";
	SET "TO_INT_PRIMITIVE=INT TO_INT_PRIMITIVE(ANY VALUE) -> integer conversion; invalid -> ERROR";
	SET "TO_FLOAT_PRIMITIVE=FLOAT TO_FLOAT_PRIMITIVE(ANY VALUE) -> float conversion; invalid -> ERROR";
	SET "STRLEN_PRIMITIVE=INT STRLEN_PRIMITIVE(STRING S) -> length in characters; null/missing -> 0";
	SET "CONCAT_PRIMITIVE=STRING CONCAT_PRIMITIVE(STRING A,STRING B) -> A+B; missing treated as ''";
	SET "SUBSTR_PRIMITIVE=STRING SUBSTR_PRIMITIVE(STRING S,INT START,INT LEN) -> substring; bounds clamp; missing -> ''";
	SET "SPLIT_PRIMITIVE=LIST SPLIT_PRIMITIVE(STRING S,STRING DELIM) -> list; missing -> {}";
	SET "JOIN_PRIMITIVE=STRING JOIN_PRIMITIVE(LIST L,STRING DELIM) -> string; empty -> ''";

	CONTINUE;

STATE:{OUT=PRIMITIVE_RULE_1|PRIMITIVE_RULE_2|PRIMITIVE_RULE_3|PRIMITIVE_RULE_4|OVERLAP_EXISTS_PRIMITIVE|ROUND_HALF_UP_PRIMITIVE|REPEAT_PRIMITIVE|TO_INT_PRIMITIVE|TO_FLOAT_PRIMITIVE|STRLEN_PRIMITIVE|CONCAT_PRIMITIVE|SUBSTR_PRIMITIVE|SPLIT_PRIMITIVE|JOIN_PRIMITIVE;TAG=BOOTSTRAP}
}