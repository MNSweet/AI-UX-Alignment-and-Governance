BRIDGE_WRAPPER{
PRECONDITION : TOOL_REQUESTED
ACTION :
	IF INPUTS_UNBOUND -> ERROR "Tool inputs missing" ;
	IF INPUTS_UNBOUND -> HALT ;
	IF NO_IDEMPOTENCY_KEY -> SET "IDEMPOTENCY_KEY={UUID}" ;
	IF NO_IDEMPOTENCY_KEY -> CONTINUE ;
	IF RUN -> CALL_TOOL "{tool,args}" ;
	IF RUN -> CONTINUE ;
	IF CALL_TOOL_FAILED -> EMIT_CHAT "EFD: tool failed; attempted={tool}; args={args_redacted}; suggestion={next}" ;
	IF CALL_TOOL_FAILED -> HALT ;
	IF CALL_TOOL_OK -> EMIT_LOG "AUDIT: tool={tool}; key={UUID}; ctx_hash={CONTEXT_HASH}" ;
	IF CALL_TOOL_OK -> CONTINUE ;
STATE : { REQUIRED=ARGS|IDEMPOTENCY_KEY|CTX_HASH ; AUDIT=ON ; ROLLBACK_HINTS=ON }

#@type:grammar;@schema:reference
BRIDGE_WEB_SEARCH{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "web.run{search_query:[{q:'{Q}'}],response_length:'short'}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=Q;OUT=WEB_REF}
}

#@type:grammar;@schema:reference
BRIDGE_WEB_OPEN{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "web.run{open:[{ref_id:'{REF}'}],response_length:'short'}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=REF;OUT=OPEN_REF}
}

#@type:grammar;@schema:reference
BRIDGE_PYTHON{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "python.exec{{code:\"{CODE}\"}}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=CODE;OUT=PY_OUT}
}

#@type:grammar;@schema:reference
BRIDGE_IMAGE_GEN{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "image_gen.text2im{prompt:'{PROMPT}',size:'1024x1024',n:1}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=PROMPT;OUT=IMG_REF}
}

#@type:grammar;@schema:reference
BRIDGE_FILE_SEARCH{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "file_search.msearch{queries:[{Q1},{Q2},{Q3}],source_filter:[{SRC}],source_specific_search_parameters:{{SRC}:[{query:'{Q1}'},{query:'{Q2}'},{query:'{Q3}'}]}}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=SRC|Q1|Q2|Q3;OUT=FS_REF}
}

#@type:grammar;@schema:reference
BRIDGE_FILE_CLICK{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "file_search.mclick{pointers:[{POINTER}]}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=POINTER;OUT=FC_REF}
}

#@type:grammar;@schema:reference
BRIDGE_GMAIL_SEARCH{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "gmail.search_email_ids{query:'{Q}',max_results:{MAX}}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=Q|MAX;OUT=GM_IDS}
}

#@type:grammar;@schema:reference
BRIDGE_GMAIL_READ{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "gmail.batch_read_email{message_ids:[{ID1},{ID2},{ID3}]}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=ID1|ID2|ID3;OUT=GM_MSGS}
}

#@type:grammar;@schema:reference
BRIDGE_GCAL_SEARCH{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "gcal.search_events{time_min:'{TMIN}',time_max:'{TMAX}',timezone_str:'{TZ}',max_results:{MAX},query:'{Q}'}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=TMIN|TMAX|TZ|MAX|Q;OUT=GC_EVENTS}
}

#@type:grammar;@schema:reference
BRIDGE_GCAL_READ{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "gcal.read_event{event_id:'{EID}'}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=EID;OUT=GC_EVENT}
}

#@type:grammar;@schema:reference
BRIDGE_GCONTACTS{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "gcontacts.search_contacts{query:'{Q}',max_results:{MAX}}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=Q|MAX;OUT=GCONTACTS}
}

#@type:grammar;@schema:reference
BRIDGE_AUTOMATIONS_CREATE{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "automations.create{title:'{TITLE}',prompt:'{PROMPT}',schedule:'{SCHED}'}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=TITLE|PROMPT|SCHED;OUT=AUTO_REF}
}

#@type:grammar;@schema:reference
BRIDGE_AUTOMATIONS_UPDATE{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "automations.update{jawbone_id:'{ID}',schedule:'{SCHED}',prompt:'{PROMPT}',title:'{TITLE}',is_enabled:{EN}}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=ID|SCHED|PROMPT|TITLE|EN;OUT=AUTO_REF}
}

#@type:grammar;@schema:reference
BRIDGE_BIO_UPDATE{
PRECONDITION:START
ACTION:
IF TRUE -> CALL_TOOL "bio.update{{text:\"{TEXT}\"}}";
IF TOOL_RESULT -> CONTINUE;
STATE:{IN=TEXT;OUT=BIO_OK}
}
